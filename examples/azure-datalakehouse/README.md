# Azure Data Lakehouse

This module provisions a [Data Lakehouse](https://learn.microsoft.com/en-us/azure/databricks/lakehouse/) in Azure,
by employing the following Azure resources:

- Datalake as an [Azure Storage Account](https://docs.microsoft.com/en-us/azure/storage/common/storage-account-overview)
- ETL via [Azure Data Factory](https://docs.microsoft.com/en-us/azure/data-factory/introduction)
- Data Warehousing
  via [Azure SQL Database](https://docs.microsoft.com/en-us/azure/azure-sql/database/sql-database-paas-overview)
- API Access
  via [Azure API Management](https://docs.microsoft.com/en-us/azure/api-management/api-management-key-concepts)

______________________________________________________________________

## Access Patterns

The module provisions Azure Roles and Role Assignments alongside Active Directory Groups to allow for the following
access patterns:

### Data Factory Contributor

### Data Warehouse Admins

______________________________________________________________________

## Considerations

### Azure Data Factory Github Integration

Azure Data Factory has a [Github Integration](https://docs.microsoft.com/en-us/azure/data-factory/source-control) that
allows us to store our Data Factory configuration in a Github repository.
Though we are able to configure it, we are not able to automatically authenticate against it.

This is left to the user to do manually, by following the steps outlined in
the [Azure Data Factory Github Integration](https://docs.microsoft.com/en-us/azure/data-factory/source-control#configure-github-integration)
documentation.

## Troubleshooting

### Key Vault access issues:

#### Symptom:

Sometimes, when applying, you might get an error like this:

```txt
Error: checking for presence of existing Key "[KEY NAME]" (Key Vault "[KEY VAULT FQDN]"):
keyvault.BaseClient#GetKey: Failure responding to request: StatusCode=403 -- Original Error: autorest/azure: Service returned an error.
Status=403 Code="Forbidden" Message="The user, group or application '[...]' does not have keys get permission on key vault '[NAME OF KEYVAULT];location=northeurope'.
[...]
InnerError={"code":"AccessDenied"}
```

#### Probable cause:

Key Vault Access Controls often take a while to propagate. This can cause issues when trying to access a newly created
Key Vault.

#### Resolution:

Wait a few minutes and try again.
If that does not work, review the access policies for the Key Vault and make sure that the access policies are correctly
configured.

### Key Vault Firewall issues:

#### Symptom

Sometimes, when applying, you might get an error like this:

```txt
Error: checking for presence of existing Key "[KEY NAME]" (Key Vault "[KEY VAULT FQDN]):
keyvault.BaseClient#GetKey: Failure responding to request: StatusCode=403 -- Original Error: autorest/azure: Service returned an error.
Status=403 Code="Forbidden" Message="Client address is not authorized and caller is not a trusted service.
[...]
InnerError={"code":"ForbiddenByFirewall"}
```

#### Probable cause:

The Network Access / Firewall rules for the Key Vault might be blocking your acess.

#### Resolution:

Add your IP to the Key Vault Firewall rules.

<!-- TERRAFORM_DOCS_BLOCK -->

## Inputs

| Name                                                                                                                                                                                          | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Type                                                                                                                                                                                                                                                                                                                                                                                                                    | Default                                                                                                                                            | Required |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- | :------: |
| <a name="input_budget_contact_emails"></a> [budget_contact_emails](#input_budget_contact_emails)                                                                                              | Emails to send budget notifications to                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                          | n/a                                                                                                                                                |   yes    |
| <a name="input_instance"></a> [instance](#input_instance)                                                                                                                                     | Instance name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `string`                                                                                                                                                                                                                                                                                                                                                                                                                | n/a                                                                                                                                                |   yes    |
| <a name="input_org_code"></a> [org_code](#input_org_code)                                                                                                                                     | Organization code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `string`                                                                                                                                                                                                                                                                                                                                                                                                                | n/a                                                                                                                                                |   yes    |
| <a name="input_platform_config"></a> [platform_config](#input_platform_config)                                                                                                                | `workload_subscription_id` - The ID of the subscription which we want to provision into.<br>  `platform_subscription_id` - The ID of the platform subscription.<br>  `workload_management_group_name (optional)` - The name of the management group which we want to provision our workload subscription into. If this is not set, the placement of the workload subscription inside the management group hieracry will not be changed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | <pre>object({<br>    workload_subscription_id       = string<br>    platform_subscription_id       = string<br>    workload_management_group_name = optional(string, "")<br>  })</pre>                                                                                                                                                                                                                                  | n/a                                                                                                                                                |   yes    |
| <a name="input_tier"></a> [tier](#input_tier)                                                                                                                                                 | Tier of the environment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `string`                                                                                                                                                                                                                                                                                                                                                                                                                | n/a                                                                                                                                                |   yes    |
| <a name="input_warehouse_config"></a> [warehouse_config](#input_warehouse_config)                                                                                                             | `sku_name` - The sku-name for the datawarehouse. This controls the sku-name that will be used for the SQL Server Database. sku-names vary across regions and offerings, run `az sql db list-editions -l [your region] -o table` to see available options.<br>    `max_size_gb` - This controls the max-size-gb setting, i.e. how much storage to allocate for the SQL Server Database.<br>    `zone_redundant` - Whether the datawarehouse should be zone-redundant. This controls the zone-redundant setting that will be used for the SQL Server Database. Be aware that might not be available for all sku's.<br>    `admin_group_id (optional)` - The name of an existing AD Group that should be used as an admin to the datawarehouse. If this is not set, a new AD Group will be created.<br>    `collation (optional)` - The collation to use for the datawarehouse. This controls the collation that will be used for the SQL Server Database.<br>    `ip_whitelist (optional)` - A list of maps containing ip_address / name pairs to whitelist for the datalakehouse | <pre>object({<br>    sku_name         = string<br>    max_size_gb      = optional(number, 500)<br>    zone_redundant   = optional(bool, true)<br>    admin_group_name = optional(string, "")<br>    collation        = optional(string, "Icelandic_100_CI_AS")<br>    ip_whitelist     = optional(list(any), \[\])<br>  })</pre>                                                                                        | n/a                                                                                                                                                |   yes    |
| <a name="input_adf_git_backend_config"></a> [adf_git_backend_config](#input_adf_git_backend_config)                                                                                           | Configuration for the github repository                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | <pre>object({<br>    type = string # must be either "github" or "azuredevops"<br><br>    account_name    = string<br>    branch_name     = string<br>    repository_name = string<br>    root_folder     = string<br><br>    # Required for Github<br>    git_url = optional(string)<br><br>    # Required for Azure DevOps<br>    project_name = optional(string)<br>    tenant_id    = optional(string)<br>  })</pre> | `null`                                                                                                                                             |    no    |
| <a name="input_api_management_config"></a> [api_management_config](#input_api_management_config)                                                                                              | `sku_name` - SKU name for the API management instance<br>  `sku_capacity` - SKU capacity for the API management instance<br>  `publisher_name` - Publisher name for the API management instance<br>  `publisher_email` - Publisher email for the API management instance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | <pre>object({<br>    sku_name        = optional(string, "Developer")<br>    sku_capacity    = optional(number, 1)<br>    publisher_name  = optional(string, "<your name>")<br>    publisher_email = optional(string, "")<br>  })</pre>                                                                                                                                                                                  | `null`                                                                                                                                             |    no    |
| <a name="input_budget_for_resource_group"></a> [budget_for_resource_group](#input_budget_for_resource_group)                                                                                  | Budget for the resource group                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `number`                                                                                                                                                                                                                                                                                                                                                                                                                | `50`                                                                                                                                               |    no    |
| <a name="input_datalake_whitelisted_cidrs"></a> [datalake_whitelisted_cidrs](#input_datalake_whitelisted_cidrs)                                                                               | A list of CIDRs to whitelist for the datalake                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                          | `[]`                                                                                                                                               |    no    |
| <a name="input_datalakehouse_admins"></a> [datalakehouse_admins](#input_datalakehouse_admins)                                                                                                 | A list of Azure AD User Principal ID's that are allowed to administer the Data Lakehouse.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                          | `[]`                                                                                                                                               |    no    |
| <a name="input_datalakehouse_contributor_can_contribute_to_keyvault"></a> [datalakehouse_contributor_can_contribute_to_keyvault](#input_datalakehouse_contributor_can_contribute_to_keyvault) | Whether the data engineers should be able to contribute to the key vault.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                  | `false`                                                                                                                                            |    no    |
| <a name="input_datalakehouse_contributor_group_name"></a> [datalakehouse_contributor_group_name](#input_datalakehouse_contributor_group_name)                                                 | The name of an existing AD Group that should be used as a contributor to the datalakehouse.<br>  If this is not set, a new AD Group will be created.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `string`                                                                                                                                                                                                                                                                                                                                                                                                                | `""`                                                                                                                                               |    no    |
| <a name="input_datalakehouse_contributors"></a> [datalakehouse_contributors](#input_datalakehouse_contributors)                                                                               | Contributors to the datalakehouse                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                          | `[]`                                                                                                                                               |    no    |
| <a name="input_existing_audit_keyvault_id"></a> [existing_audit_keyvault_id](#input_existing_audit_keyvault_id)                                                                               | An existing Keyvault to use for audit logs. If not provided, a new one will be created.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `string`                                                                                                                                                                                                                                                                                                                                                                                                                | `null`                                                                                                                                             |    no    |
| <a name="input_existing_resource_group_info"></a> [existing_resource_group_info](#input_existing_resource_group_info)                                                                         | An existing Resource Group to use. If not provided, a new one will be created.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | <pre>object({<br>    id       = string<br>    name     = string<br>    location = string<br>  })</pre>                                                                                                                                                                                                                                                                                                                  | `null`                                                                                                                                             |    no    |
| <a name="input_features"></a> [features](#input_features)                                                                                                                                     | Features to enable or disable.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | <pre>object({<br>    api_management = optional(bool, true)<br>    datawarehouse  = optional(bool, true)<br>    data_factory   = optional(bool, true)<br>    datalake       = optional(bool, true)<br>    keyvault       = optional(bool, true)<br>  })</pre>                                                                                                                                                            | <pre>{<br>  "api_management": true,<br>  "data_factory": true,<br>  "datalake": true,<br>  "datawarehouse": true,<br>  "keyvault": true<br>}</pre> |    no    |
| <a name="input_keyvault_ip_whitelist"></a> [keyvault_ip_whitelist](#input_keyvault_ip_whitelist)                                                                                              | IP addresses to whitelist for the keyvault                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                          | `[]`                                                                                                                                               |    no    |
| <a name="input_name_overrides"></a> [name_overrides](#input_name_overrides)                                                                                                                   | Map of resource names to override. If not set, the name will be generated from the instance name.<br>  This variable is an escape hatch for some naming scheme conflicts that can occur and should, ideally, not be used.<br>  The schema for this variable is defined inside resource and service modules and is not documented here.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                           | `{}`                                                                                                                                               |    no    |
| <a name="input_tags"></a> [tags](#input_tags)                                                                                                                                                 | Any tags that should be present on created resources. Will get merged with local.default_tags                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                           | `{}`                                                                                                                                               |    no    |

## Outputs

| Name                                                                                                                                                        | Description                                  |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------- |
| <a name="output_datafactory_info"></a> [datafactory_info](#output_datafactory_info)                                                                         | The Data Factory Info                        |
| <a name="output_datalake_info"></a> [datalake_info](#output_datalake_info)                                                                                  | The Data Lake Info                           |
| <a name="output_datalakehouse_contributor_group_info"></a> [datalakehouse_contributor_group_info](#output_datalakehouse_contributor_group_info)             | The Data Lakehouse Contributor group         |
| <a name="output_datalakehouse_warehouse_admin_group_info"></a> [datalakehouse_warehouse_admin_group_info](#output_datalakehouse_warehouse_admin_group_info) | The Data Lakehouse Warehouse Admin group     |
| <a name="output_datalakehouse_warehouse_connection_info"></a> [datalakehouse_warehouse_connection_info](#output_datalakehouse_warehouse_connection_info)    | The Data Lakehouse Warehouse Connection Info |

## Resources

| Name                                                                                                                                                                                                             | Type        |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| [azurerm_management_group_subscription_association.workload_subscription_association](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/management_group_subscription_association) | resource    |
| [azuread_user.datalakehouse_contributors](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/data-sources/user)                                                                               | data source |
| [azurerm_client_config.current](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/client_config)                                                                                | data source |
| [azurerm_management_group.workload_mgtm_group](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/management_group)                                                              | data source |
| [azurerm_subscription.workload_subscription](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/subscription)                                                                    | data source |

## Modules

| Name                                                                                                                                            | Source                              | Version |
| ----------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------- | ------- |
| <a name="module_api_management"></a> [api_management](#module_api_management)                                                                   | ../../modules/azure/api-management  | n/a     |
| <a name="module_base_setup"></a> [base_setup](#module_base_setup)                                                                               | ../../modules/azure/base-setup      | n/a     |
| <a name="module_data_engineer_group_role_assignments"></a> [data_engineer_group_role_assignments](#module_data_engineer_group_role_assignments) | ../../modules/azure/role-assignment | n/a     |
| <a name="module_data_engineer_role"></a> [data_engineer_role](#module_data_engineer_role)                                                       | ../../modules/azure/role-definition | n/a     |
| <a name="module_data_engineer_user_group"></a> [data_engineer_user_group](#module_data_engineer_user_group)                                     | ../../modules/azure/ad-group        | n/a     |
| <a name="module_datafactory"></a> [datafactory](#module_datafactory)                                                                            | ../../modules/azure/datafactory     | n/a     |
| <a name="module_datalake"></a> [datalake](#module_datalake)                                                                                     | ../../modules/azure/datalake        | n/a     |
| <a name="module_datawarehouse"></a> [datawarehouse](#module_datawarehouse)                                                                      | ../../modules/azure/datawarehouse   | n/a     |
| <a name="module_keyvault"></a> [keyvault](#module_keyvault)                                                                                     | ../../modules/azure/keyvault        | n/a     |
| <a name="module_warehouse_admin_group"></a> [warehouse_admin_group](#module_warehouse_admin_group)                                              | ../../modules/azure/ad-group        | n/a     |

## Requirements

| Name                                                                     | Version  |
| ------------------------------------------------------------------------ | -------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | >= 1.1   |
| <a name="requirement_azuread"></a> [azuread](#requirement_azuread)       | >=2.47.0 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement_azurerm)       | >=3.0.0  |

## Providers

| Name                                                         | Version |
| ------------------------------------------------------------ | ------- |
| <a name="provider_azuread"></a> [azuread](#provider_azuread) | 2.47.0  |
| <a name="provider_azurerm"></a> [azurerm](#provider_azurerm) | 3.92.0  |

<!-- /TERRAFORM_DOCS_BLOCK -->
